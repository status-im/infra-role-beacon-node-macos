#!/usr/bin/env bash
# vim: ft=sh
set -e

function headIsDetached() {
    [[ $(git rev-parse --abbrev-ref --symbolic-full-name HEAD) == "HEAD" ]];
}

function binaryExists() {
    ls -l build/{{ beacon_node_build_targets | first }}_${COMMIT} 2>&1 1>/dev/null
}

function fetchChanges() {
    # We cannot use "git pull" in here, because history may be changed upstream
    git fetch
    git reset --hard "origin/${BRANCH}"
}

function buildBinaries() {
    # Lower CPU priority so it doesn't affect the running beacon node
    NICE="nice -n 19"

    ${NICE} make -j6 update
    ${NICE} make -j6 {{ beacon_node_build_targets | join(" ") }} \
        LOG_LEVEL="TRACE" NIMFLAGS="-d:testnet_servers_image -d:noSignalHandler -d:disableMarchNative"

    # Rename binaries to match commit they were built from.
    cd build/
{% for target in beacon_node_build_targets %}
    mv {{ target }} {{ target }}_${COMMIT}

    # Create a symbolic link to the latest version
    ln -fs {{ target }}_${COMMIT} {{ target }}

{% endfor %}
    cd ..

    # Delete copies that are older than N days
    find build -mtime +{{ beacon_node_build_days_kept }} -exec rm '{}' \+
}

#-------------------------------------------------------------------------------

echo "[$(date)] Starting build script"

BRANCH="{{ beacon_node_repo_branch }}"

if [[ "${USER}" != "{{ beacon_node_user }}" ]]; then
    echo "Incorrect user: ${USER}" >&2
    echo "Expected: {{ beacon_node_user }}" >&2
    exit 1
fi

# Source profile to set correct PATH (to find homebrew binaries such as cmake)
source /etc/profile

# Build the Beacon node binaries
pushd repo >/dev/null

# Detached HEAD means we're probably on a tag
if headIsDetached; then
    echo " >>> Detached HEAD, nothing to fetch."
else
    echo " >>> Fetching changes..."
    fetchChanges
fi

COMMIT=$(git rev-parse --short=8 HEAD)

if binaryExists && [[ "$1" != "--force" ]]; then
    echo " >>> Binary already built. Run with --force flag to override"
else
    echo " >>> Building binaries..."
    buildBinaries

    # restart service
    echo " >>> Restarting service"
    cd {{ beacon_node_launchd_config_folder }}
    sudo launchctl unload {{ beacon_node_launchd_service_name }}.plist
    sudo launchctl load {{ beacon_node_launchd_service_name }}.plist
fi

popd >/dev/null

echo " >>> SUCCESS"
